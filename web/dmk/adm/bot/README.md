# 봇 관리 (Bot Management)

## 1. 개요

본 기능은 **이미 개발 완료된 외부 카카오봇 시스템**을 도매까 관리자 페이지에 연동하여, 각 지점별 카카오톡 채널 봇을 통해 메시지를 발송하고 톡방의 대화 내역을 관리하는 기능을 제공합니다. **별도의 봇 개발은 필요하지 않으며, 기존 시스템의 데이터베이스와 API를 활용합니다.**

관리자는 스케줄에 따라 정해진 메시지를 보내거나, 필요시 즉시 메시지를 전송할 수 있습니다. 각 지점은 운영용 톡방과 테스트용 톡방을 모두 가질 수 있으며, 발송 대상을 선택할 수 있습니다.

## 2. 메뉴 정보

- **상위 메뉴:** 프랜차이즈 관리 (190XXX)
- **메인 메뉴:** 봇 관리 (190200)
- **아이콘:** `fa-robot` (Font Awesome)
- **하위 메뉴:**
  - **서버 관리 (본사 전용)**
  - **봇 관리 (본사 전용)**
  - 스케줄링 발송 관리
  - 메시지 즉시 발송
  - 채팅 내역 조회

## 3. 폴더 구조 및 파일 역할

- `dmk/adm/bot/`
  - `README.md`: 본 파일. 기능의 개요와 구조 설명.
  - `bot_server_status.php`: 카카오봇 서버(Python) 프로세스 상태 조회 및 관리.
  - `bot_client_list.php`: 실제 톡방에 참여하는 클라이언트 봇 목록 및 관리.
  - `bot_schedule_list.php`: 등록된 스케줄 목록 (조회, 검색, 삭제).
  - `bot_schedule_form.php`: 스케줄 신규 등록 및 수정 폼.
  - `bot_schedule_form_update.php`: 스케줄 폼 데이터 처리 (DB 저장/수정).
  - `bot_instant_send_form.php`: 즉시 발송 메시지 작성 폼.
  - `bot_instant_send_update.php`: 즉시 발송 폼 데이터 처리 (카카오봇 API 전송).
  - `bot_chat_log_list.php`: 지점별 톡방 대화 내역 조회.
  - `lib/bot.lib.php`: **기존 카카오봇 시스템의 API 호출 및 DB 연동을 위한** 함수 라이브러리.

## 4. 주요 기능

### 4.1. 서버 관리 (본사 전용)

카카오봇 서버(Python) 프로그램의 프로세스를 관리하는 메뉴입니다. (프로세스 시작/중지/재시작 등)

### 4.2. 봇 관리 (본사 전용)

실제 지점별 톡방에 참여하여 활동하는 클라이언트 봇의 상태를 관리하고 제어하는 메뉴입니다.

### 4.3. 스케줄링 발송 관리

정해진 시간에 등록된 메시지와 이미지를 카카오톡 채널로 자동 발송합니다.

- **발송 조건:**
  - **매일 발송:** 시간만 지정 시, 매일 해당 시간에 발송.
  - **요일별 발송:** 시간과 특정 요일(들) 지정 시, 매주 해당 요일에 발송.
  - **1회성 발송:** 날짜와 시간 지정 시, 해당 일시에 1회만 발송.
- **발송 내역:** 모든 발송 결과는 로그 테이블에 기록되며, 별도 메뉴에서 확인 가능합니다.
- **계층별 권한 관리:**
  - 본사 관리자는 **[총판, 대리점, 지점]** 각 계층에 대해 스케줄링 발송 기능 사용 권한을 부여할 수 있습니다. (예: 지점만 사용, 또는 총판+대리점만 사용 등)
  - 권한을 가진 계층은 자신의 하위 계층의 스케줄 데이터를 모두 조회하고 관리할 수 있습니다. (예: 총판은 소속 대리점, 지점의 스케줄 확인 및 수정 가능)

### 4.4. 메시지 즉시 발송

관리자가 작성한 메시지와 이미지를 즉시 카카오톡 채널로 발송합니다.

- **발송 대상 선택:** 실제 운영 톡방 또는 테스트용 톡방을 선택하여 발송할 수 있습니다.

### 4.5. 채팅 내역 조회

**기존 카카오봇 시스템이** 각 지점 톡방의 모든 대화 내역을 저장한 데이터베이스 테이블을 직접 조회하여, 관리자에게 보여주는 기능을 제공합니다.

## 5. 데이터베이스 테이블

**※ 아래 테이블들은 `kb_` 접두사를 사용하는 기존 카카오봇 시스템의 테이블을 의미하며, 도매까 시스템에서는 해당 테이블을 조회하거나 데이터를 추가/수정하는 방식으로 연동합니다.**

- `kb_server_status`: 카카오봇 서버 프로세스 상태 정보.
- `kb_bot_clients`: 클라이언트 봇 목록 및 상태 정보.
- `kb_schedule`: 스케줄링 발송 설정 정보를 저장하는 테이블.
- `kb_schedule_log`: 스케줄링 발송 실행 내역 및 결과를 기록하는 테이블.
- `kb_chat_logs`: 각 지점 톡방의 모든 대화 내역을 저장하는 테이블.
*테이블 연동을 위한 설정은 `config.php` 또는 별도의 설정 파일에서 관리될 예정입니다.*

*권한 관리는 `dmk/dmk_global_settings.php`의 메뉴 설정을 통해 처리됩니다.*
