<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chain Select Test</title>
    <link rel="stylesheet" href="./dmk/adm/css/chain-select.css">
</head>
<body>
    <h1>도매까 계층형 선택박스 테스트</h1>
    
    <form id="fsearch" method="get">
        <div class="dmk-chain-select-wrapper">
            <div class="dmk-chain-select-row">
                <div class="dmk-chain-select-item">
                    <label for="sdt_id">총판</label>
                    <select name="sdt_id" id="sdt_id">
                        <option value="">전체 총판</option>
                        <option value="test_dt_01">테스트 총판 1 (test_dt_01)</option>
                        <option value="test_dt_02">테스트 총판 2 (test_dt_02)</option>
                    </select>
                </div>
                
                <div class="dmk-chain-select-item">
                    <label for="sag_id">대리점</label>
                    <select name="sag_id" id="sag_id">
                        <option value="">전체 대리점</option>
                    </select>
                </div>
                
                <div class="dmk-chain-select-item">
                    <label for="sbr_id">지점</label>
                    <select name="sbr_id" id="sbr_id">
                        <option value="">전체 지점</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 10px;">
            <input type="text" name="test_search" placeholder="검색어 입력" />
            <button type="submit">검색</button>
        </div>
    </form>
    
    <div id="debug-log" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border: 1px solid #ccc;">
        <h3>디버그 로그</h3>
        <div id="log-content"></div>
    </div>
    
    <script src="./dmk/adm/js/chain-select.js"></script>
    <script>
        // 디버그 로그 캡처
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            
            // DmkChainSelect 로그만 화면에 표시
            const message = args.join(' ');
            if (message.includes('[DmkChainSelect]')) {
                const logContent = document.getElementById('log-content');
                const logLine = document.createElement('div');
                logLine.style.padding = '2px 0';
                logLine.style.fontSize = '12px';
                logLine.style.borderBottom = '1px solid #eee';
                logLine.textContent = new Date().toLocaleTimeString() + ': ' + message;
                logContent.appendChild(logLine);
                logContent.scrollTop = logContent.scrollHeight;
            }
        };
        
        // Mock AJAX endpoints - 실제 프로젝트에서는 필요 없음
        function mockFetch(url) {
            console.log('Mock fetch called:', url);
            
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (url.includes('get_agencies.php')) {
                        const dtId = new URL(url, window.location.origin).searchParams.get('dt_id');
                        let agencies = [];
                        
                        if (dtId === 'test_dt_01') {
                            agencies = [
                                {id: 'test_ag_01_01', name: '총판1-대리점1'},
                                {id: 'test_ag_01_02', name: '총판1-대리점2'}
                            ];
                        } else if (dtId === 'test_dt_02') {
                            agencies = [
                                {id: 'test_ag_02_01', name: '총판2-대리점1'}
                            ];
                        }
                        
                        resolve({
                            ok: true,
                            text: () => Promise.resolve(JSON.stringify({
                                success: true,
                                data: agencies
                            }))
                        });
                    } else if (url.includes('get_branches.php')) {
                        const agId = new URL(url, window.location.origin).searchParams.get('ag_id');
                        let branches = [];
                        
                        if (agId === 'test_ag_01_01') {
                            branches = [
                                {id: 'test_br_01_01_01', name: '총판1-대리점1-지점1'},
                                {id: 'test_br_01_01_02', name: '총판1-대리점1-지점2'}
                            ];
                        } else if (agId === 'test_ag_01_02') {
                            branches = [
                                {id: 'test_br_01_02_01', name: '총판1-대리점2-지점1'}
                            ];
                        } else if (agId === 'test_ag_02_01') {
                            branches = [
                                {id: 'test_br_02_01_01', name: '총판2-대리점1-지점1'},
                                {id: 'test_br_02_01_02', name: '총판2-대리점1-지점2'},
                                {id: 'test_br_02_01_03', name: '총판2-대리점1-지점3'}
                            ];
                        }
                        
                        resolve({
                            ok: true,
                            text: () => Promise.resolve(JSON.stringify({
                                success: true,
                                data: branches
                            }))
                        });
                    }
                }, 500); // 0.5초 지연으로 실제 AJAX 환경 시뮬레이션
            });
        }
        
        // fetch 함수를 mock으로 대체
        window.fetch = mockFetch;
        
        // DmkChainSelect 초기화
        const chainSelect = new DmkChainSelect({
            agencyEndpoint: './get_agencies.php',
            branchEndpoint: './get_branches.php',
            autoSubmit: false, // 테스트에서는 자동 폼 제출 비활성화
            debug: true
        });
    </script>
</body>
</html>
