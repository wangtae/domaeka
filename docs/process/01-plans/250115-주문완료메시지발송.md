# 주문 완료 시 카카오톡 메시지 자동 발송 구현 계획

## 1. 개요

주문 상태가 "완료"로 변경될 때, 해당 지점의 카카오톡 채팅방으로 주문 내역을 자동으로 발송하는 시스템을 구현합니다.

## 2. 데이터베이스 스키마 변경

### 2.1 dmk_branch 테이블에 메시지 템플릿 필드 추가

```sql
-- dmk_branch 테이블에 메시지 템플릿 관련 필드 추가
ALTER TABLE `dmk_branch` 
ADD COLUMN `br_order_msg_template` TEXT DEFAULT NULL COMMENT '주문 완료 메시지 템플릿' AFTER `br_status`,
ADD COLUMN `br_order_msg_enabled` TINYINT(1) DEFAULT 1 COMMENT '주문 완료 메시지 발송 여부 (1: 발송, 0: 미발송)' AFTER `br_order_msg_template`,
ADD COLUMN `br_kakao_room_name` VARCHAR(100) DEFAULT NULL COMMENT '카카오톡 채팅방 이름' AFTER `br_order_msg_enabled`;

-- 기본 템플릿 설정
UPDATE `dmk_branch` 
SET `br_order_msg_template` = '{핸드폰뒷자리}님 주문!\n{상품목록}'
WHERE `br_order_msg_template` IS NULL;
```

### 2.2 사용 가능한 템플릿 변수

- `{핸드폰뒷자리}`: 주문자 핸드폰 번호 뒤 4자리
- `{주문자명}`: 주문자 이름
- `{주문번호}`: 주문 번호
- `{주문일시}`: 주문 일시
- `{상품목록}`: 주문 상품 목록 (자동 생성)
- `{총금액}`: 주문 총 금액
- `{배송예정일}`: 배송 예정일

## 3. 구현 방식

### 3.1 아키텍처

```
주문 상태 변경 (관리자)
    ↓
주문 상태 업데이트 (PHP)
    ↓
상태 변경 감지 (완료 체크)
    ↓
메시지 생성 (템플릿 + 데이터)
    ↓
카카오봇 서버로 발송 요청
    ↓
지점 채팅방으로 메시지 전송
```

### 3.2 구현 단계

#### Phase 1: 관리자 페이지 수정
1. 지점 관리 페이지에 메시지 템플릿 설정 UI 추가
2. 템플릿 미리보기 기능 구현
3. 채팅방 이름 설정 기능 추가

#### Phase 2: 주문 상태 변경 로직 수정
1. 주문 상태 변경 시 후처리 로직 추가
2. 상태가 "완료"로 변경될 때 메시지 발송 트리거

#### Phase 3: 메시지 생성 및 발송
1. 템플릿 파싱 및 변수 치환 함수 구현
2. 카카오봇 서버 API 호출 구현
3. 발송 로그 기록

## 4. 상세 구현 방법

### 4.1 메시지 템플릿 파서 (PHP)

```php
function dmk_parse_order_message_template($template, $order_data) {
    // 핸드폰 뒷자리 추출
    $phone_last4 = substr($order_data['od_hp'], -4);
    
    // 상품 목록 생성
    $product_list = "";
    foreach ($order_data['products'] as $product) {
        $product_list .= " - \"{$product['it_name']}\" {$product['ct_qty']}개\n";
    }
    
    // 변수 치환
    $replacements = [
        '{핸드폰뒷자리}' => $phone_last4,
        '{주문자명}' => $order_data['od_name'],
        '{주문번호}' => $order_data['od_id'],
        '{주문일시}' => date('Y-m-d H:i', strtotime($order_data['od_time'])),
        '{상품목록}' => trim($product_list),
        '{총금액}' => number_format($order_data['od_cart_price']) . '원',
        '{배송예정일}' => $order_data['od_hope_date']
    ];
    
    return strtr($template, $replacements);
}
```

### 4.2 카카오봇 서버 연동

```php
function dmk_send_order_complete_message($branch_id, $order_id) {
    // 지점 정보 조회
    $branch = sql_fetch("SELECT * FROM dmk_branch WHERE br_id = '$branch_id'");
    
    if (!$branch['br_order_msg_enabled'] || empty($branch['br_kakao_room_name'])) {
        return false;
    }
    
    // 주문 정보 조회
    $order = dmk_get_order_details($order_id);
    
    // 메시지 생성
    $message = dmk_parse_order_message_template($branch['br_order_msg_template'], $order);
    
    // 카카오봇 서버로 발송 요청
    $api_data = [
        'room' => $branch['br_kakao_room_name'],
        'message' => $message,
        'type' => 'order_complete'
    ];
    
    // API 호출
    $result = dmk_call_kakaobot_api('/send_message', $api_data);
    
    // 로그 기록
    dmk_log_message_send($order_id, $branch_id, $message, $result);
    
    return $result;
}
```

### 4.3 주문 상태 변경 훅

```php
// 기존 주문 상태 변경 함수에 추가
function update_order_status($od_id, $new_status) {
    $old_status = sql_fetch("SELECT od_status FROM g5_shop_order WHERE od_id = '$od_id'")['od_status'];
    
    // 상태 업데이트
    sql_query("UPDATE g5_shop_order SET od_status = '$new_status' WHERE od_id = '$od_id'");
    
    // 완료 상태로 변경 시 메시지 발송
    if ($old_status != '완료' && $new_status == '완료') {
        $order = sql_fetch("SELECT dmk_od_br_id FROM g5_shop_order WHERE od_id = '$od_id'");
        if ($order['dmk_od_br_id']) {
            dmk_send_order_complete_message($order['dmk_od_br_id'], $od_id);
        }
    }
}
```

## 5. 카카오봇 서버 측 구현

### 5.1 새로운 API 엔드포인트 추가

```python
# server/services/order_message_service.py
async def send_order_complete_message(room_name, message):
    """주문 완료 메시지를 특정 채팅방으로 전송"""
    # 활성화된 봇 중 해당 채팅방에 권한이 있는 봇 찾기
    authorized_bot = await find_authorized_bot_for_room(room_name)
    
    if not authorized_bot:
        return {"success": False, "error": "No authorized bot found for room"}
    
    # 메시지 전송
    await send_message_to_client(
        authorized_bot['client_id'],
        {
            "event": "messageResponse",
            "data": {
                "room": room_name,
                "text": message
            }
        }
    )
    
    return {"success": True}
```

## 6. 관리자 페이지 UI

### 6.1 지점 관리 페이지에 추가할 필드

```html
<!-- 메시지 템플릿 설정 -->
<div class="form-group">
    <label>주문 완료 메시지 템플릿</label>
    <textarea name="br_order_msg_template" class="form-control" rows="5">{핸드폰뒷자리}님 주문!
{상품목록}</textarea>
    <small class="form-text text-muted">
        사용 가능한 변수: {핸드폰뒷자리}, {주문자명}, {주문번호}, {주문일시}, {상품목록}, {총금액}, {배송예정일}
    </small>
</div>

<!-- 카카오톡 채팅방 설정 -->
<div class="form-group">
    <label>카카오톡 채팅방 이름</label>
    <input type="text" name="br_kakao_room_name" class="form-control" placeholder="예: 도매까 강남지점">
</div>

<!-- 메시지 발송 여부 -->
<div class="form-group">
    <label>
        <input type="checkbox" name="br_order_msg_enabled" value="1" checked>
        주문 완료 시 자동 메시지 발송
    </label>
</div>
```

## 7. 보안 고려사항

1. **권한 검증**: 메시지 발송 전 지점 권한 확인
2. **중복 발송 방지**: 동일 주문에 대한 중복 발송 방지 로직
3. **발송 로그**: 모든 발송 내역 기록 및 추적
4. **템플릿 검증**: 악의적인 코드 삽입 방지

## 8. 확장 가능성

1. **다양한 상태 알림**: 주문 접수, 배송 시작 등 다른 상태에도 메시지 발송
2. **개인화 메시지**: 고객별 맞춤 메시지 템플릿
3. **이미지 첨부**: 상품 이미지와 함께 발송
4. **통계 및 분석**: 메시지 발송률, 응답률 등 분석

## 9. 구현 우선순위

1. **Phase 1** (필수)
   - DB 스키마 변경
   - 기본 템플릿 파서 구현
   - 주문 완료 시 메시지 발송

2. **Phase 2** (권장)
   - 관리자 UI 구현
   - 템플릿 미리보기
   - 발송 로그 조회

3. **Phase 3** (선택)
   - 다양한 상태 알림
   - 통계 대시보드
   - 고급 템플릿 기능