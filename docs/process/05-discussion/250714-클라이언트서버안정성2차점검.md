# ν΄λΌμ΄μ–ΈνΈ-μ„λ²„ μ•μ •μ„± 2μ°¨ μ κ²€ λ³΄κ³ μ„

## μ‘μ„±μΌ: 2025-07-14
## μ κ²€ λ€μƒ
- **Domaeka μ„λ²„**: `/home/wangt/projects/client/domaeka/domaeka.dev/server` (domaeka.dev ν”„λ΅μ νΈ)
- **Kkobot μ„λ²„**: `/home/wangt/projects/personal/kkobot/kkobot.dev/server` (kkobot ν”„λ΅μ νΈ)  
- **κ³µν†µ ν΄λΌμ΄μ–ΈνΈ**: `/client/messengerbotR/bridge-v3.2.2.js`

> **μ°Έκ³ **: λ³Έ λ¬Έμ„μ—μ„ "κ²½λ‰ μ„λ²„"μ™€ "κ³ κΈ‰ μ„λ²„"λΌλ” ν‘ν„μ€ κΈ°λ¥μ λ³µμ΅λ„ μ°¨μ΄λ¥Ό μ„¤λ…ν•κΈ° μ„ν• κ²ƒμ…λ‹λ‹¤. Domaeka μ„λ²„κ°€ κ²½λ‰ μ„λ²„λ¥Ό μ§€ν–¥ν•λ” κ²ƒμ€ μ•„λ‹λ©°, λ‘ μ„λ²„μ κΈ°λ³Έ ν†µμ‹  μ‹μ¤ν…μ€ λ™μΌν•κ² μ μ§€λμ–΄μ•Ό ν•©λ‹λ‹¤. Kkobot μ„λ²„λ” λ¶€κ°€ κΈ°λ¥μ΄ λ§μ΄ μ¶”κ°€λμ–΄ λΉ„λ€ν•΄μ§„ κ²ƒμΌ λΏμ…λ‹λ‹¤.

## 1. μ•„ν‚¤ν…μ² λΉ„κµ λ¶„μ„

### 1.1 λ©”μ‹μ§€ μ²λ¦¬ λ°©μ‹ λΉ„κµ (μ—…λ°μ΄νΈ ν›„)

| κµ¬λ¶„ | Domaeka μ„λ²„ (server) | Kkobot μ„λ²„ (server-kkobot) | μƒνƒ |
|------|-------------------|-------------------------|------|
| **μ²λ¦¬ ν¨ν„΄** | μ›μ»¤ ν ν¨ν„΄ (λΉ„λ™κΈ°) | μ›μ»¤ ν ν¨ν„΄ (λΉ„λ™κΈ°) | β… λ™μΌ |
| **λ™μ‹ μ²λ¦¬** | 31κ° μ›μ»¤ μ ν• | 31κ° μ›μ»¤ μ ν• | β… λ™μΌ |
| **λ©”μ‹μ§€ ν** | asyncio.Queue μ‚¬μ© | asyncio.Queue μ‚¬μ© | β… λ™μΌ |
| **μ²λ¦¬ μ§€μ—°** | λ³΄ν†µ (ν λ€κΈ°) | λ³΄ν†µ (ν λ€κΈ°) | β… λ™μΌ |
| **λ¶€ν• λ¶„μ‚°** | μ›μ»¤κ°„ μλ™ λ¶„μ‚° | μ›μ»¤κ°„ μλ™ λ¶„μ‚° | β… λ™μΌ |
| **λ°±ν”„λ μ…”** | ν ν¬κΈ° μ ν• (10000) | ν ν¬κΈ° μ ν• | β… λ™μΌ |

> **κµ¬ν„ μ™„λ£**: Domaeka μ„λ²„λ„ μ΄μ  Kkobot μ„λ²„μ™€ λ™μΌν• μ›μ»¤ ν ν¨ν„΄μ„ μ‚¬μ©ν•©λ‹λ‹¤. 31κ°μ μ›μ»¤κ°€ asyncio.Queueλ¥Ό ν†µν•΄ λ©”μ‹μ§€λ¥Ό λΉ„λ™κΈ°μ μΌλ΅ μ²λ¦¬ν•©λ‹λ‹¤.

### 1.2 μ—°κ²° κ΄€λ¦¬ λΉ„κµ

| κµ¬λ¶„ | Domaeka μ„λ²„ | Kkobot μ„λ²„ | μƒνƒ |
|------|----------|----------|------|
| **ν΄λΌμ΄μ–ΈνΈ μ¶”μ ** | β… (bot_name, device_id) κΈ°λ° | β… (bot_name, device_id) κΈ°λ° | β… κµ¬ν„ μ™„λ£ |
| **ν•Έλ“μ…°μ΄ν¬** | β… λ””λ°”μ΄μ¤ μΉμΈ μ‹μ¤ν… | β… λ””λ°”μ΄μ¤ μΉμΈ μ‹μ¤ν… | β… λ™μΌ |
| **ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ** | β… 10μ΄ νƒ€μ„μ•„μ›ƒ | β… 10μ΄ νƒ€μ„μ•„μ›ƒ | β… λ™μΌ |
| **μΈμ¦ λ°©μ‹** | β… HMAC + DB μΉμΈ | β… HMAC + DB μΉμΈ | β… λ™μΌ |
| **ping λ¨λ‹ν„°λ§** | β… kb_ping_monitor μ €μ¥ | β… kb_ping_monitor μ €μ¥ | β… λ™μΌ |
| **μ„¤μ • κ΄€λ¦¬** | μλ™ | μλ™ μƒμ„± (λ΄‡λ³„) | π† κ³ κΈ‰ |
| **μ¬μ—°κ²° μ²λ¦¬** | ν΄λΌμ΄μ–ΈνΈ μμ΅΄ | ν΄λΌμ΄μ–ΈνΈ μμ΅΄ | β–οΈ λ™λ“± |

> **κµ¬ν„ μ™„λ£ (2025-07-14)**: 
> - μ–‘μ½ μ„λ²„ λ¨λ‘ `(bot_name, device_id)` κΈ°λ° ν΄λΌμ΄μ–ΈνΈ μ¶”μ  κµ¬ν„
> - Domaeka μ„λ²„μ— Kkobot μ„λ²„μ™€ λ™μΌν• ν•Έλ“μ…°μ΄ν¬ λ° μΈμ¦ λ°©μ‹ μ μ©
> - ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ(10μ΄) λ° μ½κΈ° νƒ€μ„μ•„μ›ƒ(30μ΄) κµ¬ν„
> - ping μ΄λ²¤νΈ λ¨λ‹ν„°λ§ λ° DB μ €μ¥ κΈ°λ¥ μ¶”κ°€

#### ν΄λΌμ΄μ–ΈνΈ μ¶”μ  λ°©μ‹ κ°μ„  μ™„λ£ (2025-07-14)

**β… Domaeka μ„λ²„μ κ°μ„ λ ν΄λΌμ΄μ–ΈνΈ μ¶”μ **:
```python
# core/globals.py
clients = {}  # {(bot_name, device_id): writer} - bot_nameκ³Ό device_idλ΅ ν΄λΌμ΄μ–ΈνΈ μ¶”μ 
clients_by_addr = {}  # {(ip, port): (bot_name, device_id)} - μ£Όμ†λ΅ ν΄λΌμ΄μ–ΈνΈ μ°ΎκΈ°μ©

# ν΄λΌμ΄μ–ΈνΈ λ“±λ΅ μμ‹ (core/client_handler.py)
client_key = (bot_name, device_id)
g.clients[client_key] = writer
g.clients_by_addr[client_addr] = client_key
```

**β… Kkobot μ„λ²„μ κ°μ„ λ ν΄λΌμ΄μ–ΈνΈ μ¶”μ **:
```python
# core/globals.py
clients = {}  # {(bot_name, device_id): {addr: writer}} - bot_nameκ³Ό device_idλ΅ ν΄λΌμ΄μ–ΈνΈ μ¶”μ 
clients_by_addr = {}  # {addr: (bot_name, device_id)} - μ£Όμ†λ΅ ν΄λΌμ΄μ–ΈνΈ μ°ΎκΈ°μ©

# ν΄λΌμ΄μ–ΈνΈ λ“±λ΅ μμ‹ (core/client_handler.py)
client_key = (bot_name, device_id)
g.clients.setdefault(client_key, {})[addr] = writer
g.clients_by_addr[addr] = client_key
```

**κ°μ„  ν¨κ³Ό**:
1. **λ¨λ°”μΌ ν™κ²½ λ€μ‘**:
   - IP λ³€κ²½ μ‹μ—λ„ λ™μΌν• λ””λ°”μ΄μ¤λ΅ μΈμ‹
   - WiFi β†” λ¨λ°”μΌ λ°μ΄ν„° μ „ν™ μ‹ μ—°μ†μ„± μ μ§€
   
2. **λ°μ΄ν„°λ² μ΄μ¤ μΌμΉμ„±**:
   - `kb_bot_devices` ν…μ΄λΈ” κµ¬μ΅°μ™€ λ™μΌν• ν‚¤ μ‚¬μ©
   - λ””λ°”μ΄μ¤ κ΄€λ¦¬μ μΌκ΄€μ„± ν™•λ³΄
   
3. **κΈ°μ΅΄ μ—°κ²° κ΄€λ¦¬ κ°μ„ **:
   - λ™μΌν• λ””λ°”μ΄μ¤ μ¬μ—°κ²° μ‹ κΈ°μ΅΄ μ—°κ²° μλ™ μ •λ¦¬
   - μΆ€λΉ„ μ—°κ²° λ°©μ§€

> **κµ¬ν„ μ™„λ£**: 2025-07-14 κΈ°μ¤€μΌλ΅ μ–‘μ½ μ„λ²„ λ¨λ‘ `(bot_name, device_id)` λ³µν•© ν‚¤λ΅ ν΄λΌμ΄μ–ΈνΈ μ¶”μ μ΄ ν†µμΌλμ—μµλ‹λ‹¤.

### 1.3 λ¦¬μ†μ¤ κ΄€λ¦¬ λΉ„κµ

| κµ¬λ¶„ | Domaeka μ„λ²„ | Kkobot μ„λ²„ | μƒνƒ |
|------|----------|----------|------|
| **λ™μ‹μ„± μ μ–΄** | β… μ„Έλ§ν¬μ–΄ (λ΄‡/λ°©λ³„) | β… μ„Έλ§ν¬μ–΄ (λ΄‡/λ°©λ³„) | β… λ™μΌ |
| **λ©”λ¨λ¦¬ μ‚¬μ©** | λ‚®μ | λ†’μ | π† κ²½λ‰ |
| **CPU μ‚¬μ©** | ν¨μ¨μ  | μ¤λ²„ν—¤λ“ μμ | π† κ²½λ‰ |
| **λ¦¬μ†μ¤ λ¨λ‹ν„°λ§** | β… DB μ €μ¥ (5λ¶„) | β… DB μ €μ¥ (5λ¶„) | β… λ™μΌ |
| **κ³Όλ¶€ν• λ³΄νΈ** | β… λ‹¤λ‹¨κ³„ μ ν• | β… λ‹¤λ‹¨κ³„ μ ν• | β… λ™μΌ |

> **κµ¬ν„ μ™„λ£ (2025-07-14)**: Domaeka μ„λ²„μ—λ„ λ΄‡λ³„/λ°©λ³„ μ„Έλ§ν¬μ–΄ κΈ°λ° λ™μ‹μ„± μ μ–΄κ°€ κµ¬ν„λμ—μµλ‹λ‹¤:
> - λ΄‡λ³„ μµλ€ 30κ° λ™μ‹ λ©”μ‹μ§€ μ²λ¦¬
> - λ°©λ³„ μµλ€ 3κ° λ™μ‹ λ©”μ‹μ§€ μ²λ¦¬ (κΈ°λ³Έκ°’)
> - 5λ¶„ νƒ€μ„μ•„μ›ƒμΌλ΅ λ¬΄ν• λ€κΈ° λ°©μ§€

### 1.4 μ•μ •μ„± κΈ°λ¥ λΉ„κµ

| κµ¬λ¶„ | κ²½λ‰ μ„λ²„ | κ³ κΈ‰ μ„λ²„ | μ°μ„ |
|------|----------|----------|------|
| **μ¤λ¥ μ²λ¦¬** | κΈ°λ³Έ try-catch | κ³„μΈµμ  μ¤λ¥ κ΄€λ¦¬ | π† κ³ κΈ‰ |
| **νƒ€μ„μ•„μ›ƒ** | 30μ΄ μ½κΈ° | λ‹¤μ¤‘ νƒ€μ„μ•„μ›ƒ | π† κ³ κΈ‰ |
| **λ³µκµ¬ λ©”μ»¤λ‹μ¦** | λ‹¨μ μ¬μ‹μ‘ | λ‹¨κ³„λ³„ λ³µκµ¬ | π† κ³ κΈ‰ |
| **λ΅κΉ…** | κΈ°λ³Έ λ λ²¨ | μΉ΄ν…κ³ λ¦¬λ³„ μ μ–΄ | π† κ³ κΈ‰ |
| **λ¨λ‹ν„°λ§** | ping only | μ„±λ¥ ν”„λ΅νμΌλ§ | π† κ³ κΈ‰ |

## 2. ν†µμ‹  ν”„λ΅ν† μ½ λ¶„μ„

### 2.1 Ping λ©”μ»¤λ‹μ¦ λΉ„κµ

| ν•­λ© | κ²½λ‰ μ„λ²„ | κ³ κΈ‰ μ„λ²„ | κ¶μ¥μ‚¬ν•­ |
|------|----------|----------|----------|
| **ping μ£ΌκΈ°** | β… ν΄λΌμ΄μ–ΈνΈλ³„ νƒ€μ΄λ¨Έ | β… ν΄λΌμ΄μ–ΈνΈλ³„ νƒ€μ΄λ¨Έ | β… λ™μΌ |
| **ping λ¶„μ‚°** | 0-5μ΄ λλ¤ | μ—°κ²° μ‹μ  κΈ°λ° | κ²½λ‰ λ°©μ‹ μ±„νƒ |
| **ping λ°μ΄ν„°** | μµμ† μ •λ³΄ | μƒμ„Έ λ¨λ‹ν„°λ§ ν¬ν•¨ | μ„ νƒμ  μ±„νƒ |
| **ping μ‘λ‹µ μ²λ¦¬** | β… DB μ €μ¥ | β… DB μ €μ¥ | β… λ™μΌ |

### 2.2 λ©”μ‹μ§€ νλ¦„ μ•μ •μ„±

```mermaid
graph TD
    subgraph "κ²½λ‰ μ„λ²„ νλ¦„"
        C1[ν΄λΌμ΄μ–ΈνΈ] -->|μ§μ ‘| H1[ν•Έλ“¤λ¬]
        H1 --> P1[ν”„λ΅μ„Έμ„]
        P1 --> R1[μ‘λ‹µ]
    end
    
    subgraph "κ³ κΈ‰ μ„λ²„ νλ¦„"
        C2[ν΄λΌμ΄μ–ΈνΈ] -->|ν| Q[λ©”μ‹μ§€ ν]
        Q --> W1[μ›μ»¤1]
        Q --> W2[μ›μ»¤2]
        Q --> W3[μ›μ»¤N]
        W1 --> S[μ„Έλ§ν¬μ–΄]
        S --> P2[ν”„λ΅μ„Έμ„]
        P2 --> R2[μ‘λ‹µ]
    end
```

## 3. μ•μ •μ„± μ²΄ν¬ν¬μΈνΈ ν‰κ°€

### 3.1 μ—°κ²° μ•μ •μ„± (Connection Stability)

| μ²΄ν¬ν¬μΈνΈ | Domaeka μ„λ²„ | Kkobot μ„λ²„ | μ¤‘μ”λ„ |
|------------|-----------|-----------|--------|
| ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ | β… 10μ΄ | β… 10μ΄ | π”΄ λ†’μ |
| μ—°κ²° μƒνƒ μ¶”μ  | β… κΈ°λ³Έ | β… κΈ°λ³Έ | β… λ™μΌ |
| μΆ€λΉ„ μ—°κ²° κ°μ§€ | β… ping + timeout | β… ping + timeout | β… λ™μΌ |
| μ¬μ—°κ²° μ§€μ› | β… ν΄λΌμ΄μ–ΈνΈ | β… ν΄λΌμ΄μ–ΈνΈ | π”΄ λ†’μ |
| IP λ³€κ²½ λ€μ‘ | β… device_id κΈ°λ° | β… device_id κΈ°λ° | π΅ μ¤‘κ°„ |

### 3.2 λ°μ΄ν„° λ¬΄κ²°μ„± (Data Integrity)

| μ²΄ν¬ν¬μΈνΈ | κ²½λ‰ μ„λ²„ | κ³ κΈ‰ μ„λ²„ | μ¤‘μ”λ„ |
|------------|-----------|-----------|--------|
| λ©”μ‹μ§€ μμ„ λ³΄μ¥ | β οΈ μ›μ»¤ κ²½μ | β οΈ μ›μ»¤ κ²½μ | π”΄ λ†’μ |
| λ©”μ‹μ§€ μ¤‘λ³µ λ°©μ§€ | β μ—†μ | β μ—†μ | π΅ μ¤‘κ°„ |
| λ©”μ‹μ§€ μ μ‹¤ κ°μ§€ | β μ—†μ | β οΈ ν μ¤λ²„ν”λ΅ | π”΄ λ†’μ |
| νΈλμ­μ… λ³΄μ¥ | β μ—†μ | β μ—†μ | πΆ λ‚®μ |

### 3.3 μ„±λ¥ μ•μ •μ„± (Performance Stability)

| μ²΄ν¬ν¬μΈνΈ | Domaeka μ„λ²„ | Kkobot μ„λ²„ | μ¤‘μ”λ„ |
|------------|-----------|-----------|--------|
| λ©”λ¨λ¦¬ λ„μ λ°©μ§€ | β… ν†µν•© κ΄€λ¦¬ | β… ν†µν•© κ΄€λ¦¬ | π”΄ λ†’μ |
| CPU κ³Όλ¶€ν• λ°©μ§€ | β… μ„Έλ§ν¬μ–΄ | β… μ„Έλ§ν¬μ–΄ | π”΄ λ†’μ |
| μ‘λ‹µ μ‹κ°„ μΌκ΄€μ„± | β οΈ ν λ³€λ™ | β οΈ ν λ³€λ™ | π΅ μ¤‘κ°„ |
| μ²λ¦¬λ‰ ν™•μ¥μ„± | β… μ›μ»¤ μ΅°μ • | β… μ›μ»¤ μ΅°μ • | π΅ μ¤‘κ°„ |

### 3.4 μ¤λ¥ λ³µκµ¬ (Error Recovery)

| μ²΄ν¬ν¬μΈνΈ | κ²½λ‰ μ„λ²„ | κ³ κΈ‰ μ„λ²„ | μ¤‘μ”λ„ |
|------------|-----------|-----------|--------|
| λ¶€λ¶„ μ‹¤ν¨ μ²λ¦¬ | β οΈ κΈ°λ³Έ | β… μƒμ„Έ | π”΄ λ†’μ |
| μλ™ λ³µκµ¬ | β μ—†μ | β οΈ λ¶€λ¶„μ  | π΅ μ¤‘κ°„ |
| μ¤λ¥ μ „ν μ°¨λ‹¨ | β… κ²©λ¦¬λ¨ | β… μ›μ»¤ κ²©λ¦¬ | π”΄ λ†’μ |
| μƒνƒ λ³µκµ¬ | β μ—†μ | β οΈ λ¶€λ¶„μ  | π΅ μ¤‘κ°„ |

## 4. λ°κ²¬λ μ·¨μ•½μ  λ° κ°μ„ μ‚¬ν•­

### 4.1 κ³µν†µ μ·¨μ•½μ 
1. **λ©”μ‹μ§€ ID λ¶€μ¬**: μ¤‘λ³µ κ°μ§€ λ° μμ„ λ³΄μ¥ λ¶κ°€
2. ~~**ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ μ—†μ**~~ β… **ν•΄κ²°λ¨** (2025-07-14): 
   - β… μ–‘μ½ μ„λ²„ λ¨λ‘ 10μ΄ ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ κµ¬ν„ μ™„λ£
3. **λ©”μ‹μ§€ ν¬κΈ° μ ν• μ—†μ**: λ©”λ¨λ¦¬ κ³µκ²© κ°€λ¥
4. **μ•”νΈν™” μ—†μ**: ν‰λ¬Έ ν†µμ‹ 
5. ~~**μλ»λ ν΄λΌμ΄μ–ΈνΈ μ¶”μ  ν‚¤**~~ β… **ν•΄κ²°λ¨** (2025-07-14): 
   - ~~λ‘ μ„λ²„ λ¨λ‘ IP μ£Όμ†λ‚ Writer κ°μ²΄λ¥Ό ν‚¤λ΅ μ‚¬μ©~~
   - β… μ–‘μ½ μ„λ²„ λ¨λ‘ `(bot_name, device_id)` λ³µν•© ν‚¤ μ‚¬μ©μΌλ΅ κ°μ„  μ™„λ£

### 4.2 Domaeka μ„λ²„ λ‚¨μ€ κ°μ„ μ‚¬ν•­
```python
# 1. β… ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ μ¶”κ°€ (κµ¬ν„ μ™„λ£)

# 2. λ©”μ‹μ§€ ν¬κΈ° μ ν• (μ•„μ§ λ―Έκµ¬ν„)
MAX_MESSAGE_SIZE = 1024 * 1024  # 1MB
data = await reader.read(MAX_MESSAGE_SIZE)

# 3. κΈ°λ³Έ λ™μ‹μ„± μ μ–΄ (μ•„μ§ λ―Έκµ¬ν„)
MAX_CONCURRENT_CONNECTIONS = 100
connection_semaphore = asyncio.Semaphore(MAX_CONCURRENT_CONNECTIONS)
```

### 4.3 κ³ κΈ‰ μ„λ²„ κ°μ„  ν•„μ”μ‚¬ν•­
```python
# 1. μ›μ»¤ ν—¬μ¤μ²΄ν¬
async def monitor_worker_health():
    while True:
        stuck_workers = []
        for worker_id, last_activity in worker_activities.items():
            if time.time() - last_activity > WORKER_TIMEOUT:
                stuck_workers.append(worker_id)
        
        if stuck_workers:
            logger.error(f"Stuck workers detected: {stuck_workers}")
            # μ›μ»¤ μ¬μ‹μ‘ λ΅μ§
        
        await asyncio.sleep(60)

# 2. λ©”μ‹μ§€ μμ„ λ³΄μ¥
class OrderedMessageQueue:
    def __init__(self):
        self.queues = {}  # channel_id -> asyncio.Queue
    
    async def put(self, channel_id, message):
        if channel_id not in self.queues:
            self.queues[channel_id] = asyncio.Queue()
        await self.queues[channel_id].put(message)

# 3. μ„Έλ§ν¬μ–΄ λ°λ“λ½ λ°©μ§€
async def acquire_with_timeout(semaphore, timeout=5):
    try:
        async with asyncio.timeout(timeout):
            await semaphore.acquire()
    except asyncio.TimeoutError:
        raise DeadlockError("μ„Έλ§ν¬μ–΄ νλ“ νƒ€μ„μ•„μ›ƒ")
```

## 5. μƒνΈ μ μ© κ°€λ¥ν• κ°μ„ μ‚¬ν•­

### 5.1 Domaeka μ„λ²„κ°€ μ±„νƒν• Kkobot κΈ°λ¥ (κµ¬ν„ μ™„λ£)
| κΈ°λ¥ | κµ¬ν„ λ³µμ΅λ„ | ν¨κ³Ό | μƒνƒ |
|------|------------|------|----------|
| μ›μ»¤ ν (31κ°) | π΅ μ¤‘κ°„ | μ²λ¦¬λ‰ ν–¥μƒ | β… κµ¬ν„ μ™„λ£ |
| λ””λ°”μ΄μ¤ μ¶”μ  | π΅ μ¤‘κ°„ | λ³΄μ• ν–¥μƒ | β… κµ¬ν„ μ™„λ£ |
| ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ | πΆ λ‚®μ | λ³΄μ• ν–¥μƒ | β… κµ¬ν„ μ™„λ£ |
| ping λ¨λ‹ν„°λ§ | πΆ λ‚®μ | κ°€μ‹μ„± ν–¥μƒ | β… κµ¬ν„ μ™„λ£ |
| μ„Έλ§ν¬μ–΄ λ™μ‹μ„± μ μ–΄ | πΆ λ‚®μ | DoS λ°©μ§€ | β… κµ¬ν„ μ™„λ£ |

### 5.2 Domaeka μ„λ²„ μ¶”κ°€ κµ¬ν„ κ°€λ¥ κΈ°λ¥
| κΈ°λ¥ | κµ¬ν„ λ³µμ΅λ„ | ν¨κ³Ό | μ°μ„ μμ„ |
|------|------------|------|----------|
| μ„±λ¥ νƒ€μ΄λ¨Έ | πΆ λ‚®μ | λ³‘λ© λ°κ²¬ | π΅ μ¤‘κ°„ |
| μ„¤μ • μλ™ μƒμ„± | π΅ μ¤‘κ°„ | μ΄μ νΈμμ„± | πΆ λ‚®μ |
| μƒμ„Έ λ¨λ‹ν„°λ§ | π΅ μ¤‘κ°„ | κ°€μ‹μ„± ν–¥μƒ | π΅ μ¤‘κ°„ |

### 5.3 Kkobot μ„λ²„κ°€ Domaekaμ—μ„ μ°Έκ³ ν•  κΈ°λ¥
| κΈ°λ¥ | κµ¬ν„ λ³µμ΅λ„ | ν¨κ³Ό | μ°μ„ μμ„ |
|------|------------|------|----------|
| Ping μ‹κ°„ λ¶„μ‚° | πΆ λ‚®μ | λ¶€ν• λ¶„μ‚° | π”΄ λ†’μ |
| λ‹¨μ μ¬μ‹μ‘ λ΅μ§ | πΆ λ‚®μ | λ³µκµ¬ μ‹κ°„ λ‹¨μ¶• | π΅ μ¤‘κ°„ |
| μ§μ ‘ μ²λ¦¬ μµμ… | π΅ μ¤‘κ°„ | μ €μ§€μ—° λ¨λ“ | πΆ λ‚®μ |

## 6. κ¶μ¥ ν•μ΄λΈλ¦¬λ“ μ•„ν‚¤ν…μ²

```python
class HybridServer:
    def __init__(self):
        # κ²½λ‰ λ¨λ“μ™€ κ³ κΈ‰ λ¨λ“ μ„ νƒ κ°€λ¥
        self.mode = os.getenv('SERVER_MODE', 'lightweight')
        
        # κ³µν†µ κΈ°λ¥
        self.connection_limit = asyncio.Semaphore(1000)
        self.message_id_cache = TTLCache(maxsize=10000, ttl=300)
        
        # λ¨λ“λ³„ μ΄κΈ°ν™”
        if self.mode == 'advanced':
            self.message_queue = asyncio.Queue(maxsize=10000)
            self.workers = []
            self.semaphores = {}
        
    async def handle_connection(self, reader, writer):
        async with self.connection_limit:
            # κ³µν†µ ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ
            async with asyncio.timeout(10):
                await self.handshake(reader, writer)
            
            if self.mode == 'lightweight':
                await self.direct_processing(reader, writer)
            else:
                await self.queued_processing(reader, writer)
```

## 7. κµ¬ν„ λ΅λ“λ§µ

### Phase 1 (1μ£Όμ°¨) - κΈ΄κΈ‰ λ³΄μ• ν¨μΉ
- [x] ~~ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ κµ¬ν„~~ β… μ™„λ£ (2025-07-14)
- [ ] λ©”μ‹μ§€ ν¬κΈ° μ ν•
- [ ] κΈ°λ³Έ μ—°κ²° μ μ ν•

### Phase 2 (2-3μ£Όμ°¨) - μ•μ •μ„± ν–¥μƒ
- [ ] λ©”μ‹μ§€ ID μ‹μ¤ν…
- [ ] μ¤‘λ³µ λ©”μ‹μ§€ ν•„ν„°λ§
- [ ] ν–¥μƒλ μ¤λ¥ λ΅κΉ…
- [x] ~~ν΄λΌμ΄μ–ΈνΈ μ¶”μ  κ°μ„ ~~ β… μ™„λ£ (2025-07-14)

### Phase 3 (4-6μ£Όμ°¨) - μ„±λ¥ μµμ ν™”
- [x] ~~μ›μ»¤ ν μ‹μ¤ν…~~ β… μ™„λ£ (2025-07-14)
- [ ] μ„±λ¥ λ¨λ‹ν„°λ§ λ€μ‹λ³΄λ“
- [ ] μλ™ μ¤μΌ€μΌλ§ λ΅μ§

### Phase 4 (7-8μ£Όμ°¨) - κ³ κΈ‰ κΈ°λ¥
- [ ] λ©”μ‹μ§€ μ•”νΈν™”
- [ ] μƒνƒ μ²΄ν¬ν¬μΈνΈ
- [ ] μλ™ λ³µκµ¬ μ‹μ¤ν…

## 8. κ²°λ΅  λ° κ¶μ¥μ‚¬ν•­

### 8.1 μ¦‰μ‹ μ μ© μ™„λ£ (2025-07-14)
1. β… **ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ•„μ›ƒ**: μ–‘μ½ μ„λ²„ λ¨λ‘ κµ¬ν„ μ™„λ£
2. β… **ν΄λΌμ΄μ–ΈνΈ μ¶”μ  κ°μ„ **: (bot_name, device_id) κΈ°λ°μΌλ΅ ν†µμΌ
3. β… **μ›μ»¤ ν μ‹μ¤ν…**: Domaeka μ„λ²„μ—λ„ 31κ° μ›μ»¤ κµ¬ν„
4. β… **ping λ¨λ‹ν„°λ§**: kb_ping_monitor ν…μ΄λΈ” μ—°λ™
5. β… **μ„Έλ§ν¬μ–΄ λ™μ‹μ„± μ μ–΄**: λ΄‡λ³„/λ°©λ³„ μ²λ¦¬λ‰ μ ν•

### 8.2 λ‹¨κΈ° κ°μ„  (1κ°μ›” λ‚΄)
1. **λ©”μ‹μ§€ ν¬κΈ° μ ν•**: λ©”λ¨λ¦¬ κ³µκ²© λ°©μ§€
2. **μ—°κ²°λ³„ μ„Έλ§ν¬μ–΄**: DoS κ³µκ²© λ°©μ§€
3. **λ©”μ‹μ§€ ID μ‹μ¤ν…**: μ¤‘λ³µ λ°©μ§€ λ° μμ„ λ³΄μ¥

### 8.3 μ¥κΈ° κ°μ„  (3κ°μ›” λ‚΄)
1. ν•μ΄λΈλ¦¬λ“ μ•„ν‚¤ν…μ² κµ¬ν„
2. ν†µν•© λ¨λ‹ν„°λ§ μ‹μ¤ν…
3. μλ™ λ³µκµ¬ λ©”μ»¤λ‹μ¦

## 9. 2025-07-14 κµ¬ν„ μ”μ•½

μ΄λ² κ°μ„  μ‘μ—…μ„ ν†µν•΄ Domaeka μ„λ²„μ™€ Kkobot μ„λ²„μ ν•µμ‹¬ ν†µμ‹  μ‹μ¤ν…μ΄ λ€λ¶€λ¶„ λ™μΌν• μμ¤€μΌλ΅ ν–¥μƒλμ—μµλ‹λ‹¤:

### κµ¬ν„λ μ£Όμ” κ°μ„ μ‚¬ν•­
1. **ν΄λΌμ΄μ–ΈνΈ μ¶”μ  ν†µμΌ**: μ–‘μ½ μ„λ²„ λ¨λ‘ `(bot_name, device_id)` κΈ°λ°μΌλ΅ λ³€κ²½
   - λ¨λ°”μΌ ν™κ²½μ—μ„ IP λ³€κ²½ μ‹μ—λ„ μ•μ •μ μΈ μ—°κ²° μ μ§€
   - kb_bot_devices ν…μ΄λΈ”κ³Ό μΌμΉν•λ” κµ¬μ΅°

2. **ν•Έλ“μ…°μ΄ν¬ λ³΄μ• κ°•ν™”**: 
   - 10μ΄ νƒ€μ„μ•„μ›ƒμΌλ΅ μ•…μμ  μ—°κ²° μ°¨λ‹¨
   - λ””λ°”μ΄μ¤ μΉμΈ μ‹μ¤ν… ν†µν•©
   - HMAC + DB μΉμΈ λ°©μ‹ κµ¬ν„

3. **μ„±λ¥ λ° μ•μ •μ„±**:
   - 31κ° μ›μ»¤ ν μ‹μ¤ν…μΌλ΅ μ²λ¦¬λ‰ ν–¥μƒ
   - ping λ¨λ‹ν„°λ§μΌλ΅ μ—°κ²° μƒνƒ μ¶”μ 
   - 30μ΄ μ½κΈ° νƒ€μ„μ•„μ›ƒμΌλ΅ μΆ€λΉ„ μ—°κ²° λ°©μ§€
   - λ΄‡λ³„/λ°©λ³„ μ„Έλ§ν¬μ–΄λ΅ λ™μ‹μ„± μ μ–΄ (λ΄‡λ‹Ή 30κ°, λ°©λ‹Ή 3κ°)
   - 5λ¶„ λ©”μ‹μ§€ μ²λ¦¬ νƒ€μ„μ•„μ›ƒμΌλ΅ λ¬΄ν• λ€κΈ° λ°©μ§€

### λ‚¨μ€ μ°¨μ΄μ 
- **μ„¤μ • κ΄€λ¦¬**: Kkobotμ€ μλ™ μƒμ„±, Domaekaλ” μλ™ κ΄€λ¦¬
- **λ¨λ‹ν„°λ§ μƒμ„Έλ„**: Kkobotμ΄ λ” μƒμ„Έν• μ„±λ¥ ν”„λ΅νμΌλ§ μ κ³µ

λ‘ μ„λ²„μ κΈ°λ³Έ ν†µμ‹  μ‹μ¤ν…μ€ μ΄μ  κ±°μ λ™μΌν• μμ¤€μ μ•μ •μ„±κ³Ό λ³΄μ•μ„±μ„ μ κ³µν•λ©°, κ° ν”„λ΅μ νΈμ νΉμ„±μ— λ§λ” μ¶”κ°€ κΈ°λ¥λ§ μ°¨μ΄λ¥Ό λ³΄μ΄κ³  μμµλ‹λ‹¤.

### 2025-07-14 μ¶”κ°€ κµ¬ν„: μ‹μ¤ν… λ¨λ‹ν„°λ§

**kb_system_monitor ν…μ΄λΈ” κΈ°λ° μ‹μ¤ν… λ¨λ‹ν„°λ§ κµ¬ν„**:
- μ–‘μ½ μ„λ²„ λ¨λ‘ 5λ¶„λ§λ‹¤ μ‹μ¤ν… μƒνƒλ¥Ό DBμ— μ €μ¥
- CPU, λ©”λ¨λ¦¬, λ””μ¤ν¬ μ‚¬μ©λ¥  μ¶”μ 
- ν™μ„± μ—°κ²° μ λ° λ©”μ‹μ§€ ν ν¬κΈ° λ¨λ‹ν„°λ§
- μ„λ²„λ³„λ΅ λ…λ¦½μ μΈ λ°μ΄ν„° μμ§‘ (server_nameμΌλ΅ κµ¬λ¶„)

μ΄λ΅μ¨ λ¦¬μ†μ¤ λ¨λ‹ν„°λ§ μΈ΅λ©΄μ—μ„λ„ λ‘ μ„λ²„κ°€ λ™μΌν• μμ¤€μ κΈ°λ¥μ„ μ κ³µν•κ² λμ—μµλ‹λ‹¤.

### 2025-07-15 μ¶”κ°€ κµ¬ν„: ν΄λΌμ΄μ–ΈνΈλ³„ Ping νƒ€μ΄λ¨Έ

**Domaeka μ„λ²„ Ping μ‹μ¤ν… κ°μ„ **:
- κΈ°μ΅΄ λ©”μ‹μ§€ μΉ΄μ΄ν„° κΈ°λ°μ—μ„ ν΄λΌμ΄μ–ΈνΈλ³„ λ…λ¦½ νƒ€μ΄λ¨Έλ΅ λ³€κ²½
- κ° ν΄λΌμ΄μ–ΈνΈλ§λ‹¤ 30μ΄ μ£ΌκΈ°μ λ…λ¦½μ μΈ ping νƒμ¤ν¬ μ‹¤ν–‰
- 0-5μ΄ λλ¤ μ΄κΈ° μ§€μ—°μΌλ΅ μ„λ²„ λ¶€ν• λ¶„μ‚°
- ν΄λΌμ΄μ–ΈνΈ μ—°κ²°/ν•΄μ  μ‹ μλ™μΌλ΅ ping νƒμ¤ν¬ κ΄€λ¦¬

μ΄μ  μ–‘μ½ μ„λ²„ λ¨λ‘ λ™μΌν• ν΄λΌμ΄μ–ΈνΈλ³„ ping νƒ€μ΄λ¨Έ μ‹μ¤ν…μ„ μ‚¬μ©ν•©λ‹λ‹¤.

### 2025-07-15 μ¶”κ°€ κµ¬ν„: λ©”λ¨λ¦¬ λ„μ λ°©μ§€

**μ–‘μ½ μ„λ²„ λ©”λ¨λ¦¬ κ΄€λ¦¬ ν†µν•© κµ¬ν„**:
1. **μ£ΌκΈ°μ  κ°€λΉ„μ§€ μ»¬λ ‰μ…**: 10λ¶„λ§λ‹¤ κ°•μ  GC μ‹¤ν–‰μΌλ΅ μ°Έμ΅°λμ§€ μ•λ” κ°μ²΄ μ •λ¦¬
2. **λ©”λ¨λ¦¬ μ‚¬μ©λ¥  λ¨λ‹ν„°λ§**: 5λ¶„λ§λ‹¤ μ‹μ¤ν…/ν”„λ΅μ„Έμ¤ λ©”λ¨λ¦¬ μƒνƒ μ²΄ν¬
   - 80% μ΄μƒ: κ²½κ³  λ΅κ·Έ
   - 90% μ΄μƒ: κΈ΄κΈ‰ λ©”λ¨λ¦¬ μ •λ¦¬ μ‹¤ν–‰
3. **μ¤λλ λ°μ΄ν„° μλ™ μ •λ¦¬**: 30λ¶„λ§λ‹¤ μ‹¤ν–‰
   - 1μ‹κ°„ μ΄μƒ λΉ„ν™μ„± ν΄λΌμ΄μ–ΈνΈ μƒνƒ μ κ±°
   - λ‹«ν writer κ°μ²΄ μ •λ¦¬
   - λ§λ£λ λ€ν™” μ°Έμ—¬ λΈ”λ΅ μ κ±° (Kkobot only)
4. **μν™ μ°Έμ΅° λ°©μ§€**: 
   - λ©”μ‹μ§€μ— writer κ°μ²΄ μ§μ ‘ ν¬ν•¨ μ κ±°
   - client_key (bot_name, device_id) νν”λ΅ writer μ΅°νν•λ„λ΅ λ³€κ²½

μ΄λ΅μ¨ λ‘ μ„λ²„ λ¨λ‘ λ™μΌν• μμ¤€μ λ©”λ¨λ¦¬ κ΄€λ¦¬ κΈ°λ¥μ„ κ°–μ¶”κ² λμ—μµλ‹λ‹¤.