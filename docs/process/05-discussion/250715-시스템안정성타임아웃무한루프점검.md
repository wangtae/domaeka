# 시스템 안정성 점검: 타임아웃 및 무한 루프 취약점

## 개요

2025년 1월 15일, 도매까 서버에서 읽기 타임아웃 시 무한 루프가 발생하여 시스템이 마비되는 치명적인 오류가 발견되었습니다. 이는 전체 시스템 안정성에 매우 큰 영향을 미칠 수 있는 문제로, 유사한 취약점이 다른 핵심 모듈에도 존재하는지 전면적인 점검을 실시했습니다.

## 발견된 문제

### 1. client_handler.py 무한 타임아웃 루프

#### 문제 상황
```python
# 기존 코드 (취약)
while not g.shutdown_event.is_set():
    try:
        async with asyncio.timeout(30):
            data = await read_limited_line(reader, client_max_size)
    except asyncio.TimeoutError:
        logger.warning(f"[TIMEOUT] 읽기 타임아웃: {client_addr}")
        continue  # 무한 루프 발생!
```

#### 문제점
- 클라이언트 연결이 끊어졌지만 서버가 이를 감지하지 못함
- TimeoutError 발생 시 `continue`로 인해 무한히 재시도
- 로그 파일에 타임아웃 메시지가 초당 수백 개씩 기록되며 시스템 리소스 고갈

#### 해결 방안
```python
# 수정된 코드 (안전)
timeout_count = 0
max_timeout_retries = 3

while not g.shutdown_event.is_set():
    try:
        async with asyncio.timeout(30):
            data = await read_limited_line(reader, client_max_size)
            timeout_count = 0  # 성공 시 리셋
    except asyncio.TimeoutError:
        timeout_count += 1
        logger.warning(f"[TIMEOUT] 읽기 타임아웃 ({timeout_count}/{max_timeout_retries}): {client_addr}")
        if timeout_count >= max_timeout_retries:
            logger.error(f"[TIMEOUT] 최대 타임아웃 횟수 초과, 연결 종료: {client_addr}")
            break
        continue
```

## 시스템 전반 점검 결과

### 도매까 서버 (domaeka.dev/server)

| 모듈 | 상태 | 위험도 | 비고 |
|------|------|--------|------|
| core/server.py | ✅ 안전 | 낮음 | shutdown_event.wait() 사용, 무한 루프 없음 |
| core/client_handler.py | ⚠️ 수정됨 | 높음 | 타임아웃 재시도 제한 추가 |
| core/message_processor.py | ✅ 안전 | 낮음 | 무한 루프 없음 |
| core/worker.py | ✅ 안전 | 낮음 | shutdown_event 기반 종료, 타임아웃 적절히 처리 |
| core/ping_scheduler_v2.py | ✅ 안전 | 낮음 | shutdown_event 기반 종료 |
| database/connection.py | ✅ 안전 | 낮음 | 타임아웃 예외 처리 적절 |

### kkobot 서버 (kkobot.dev/server)

| 모듈 | 상태 | 위험도 | 비고 |
|------|------|--------|------|
| core/client_handler.py | ⚠️ 수정됨 | 높음 | 도매까와 동일한 문제 발견 및 수정 |
| core/scheduler.py | ⚠️ 위험 | 중간 | while True 사용, 예외 처리 미흡 |
| core/sessions/session_scheduler.py | ❓ 미점검 | 중간 | 추가 점검 필요 |

## 권장 개선 사항

### 1. 타임아웃 처리 표준화
```python
# 표준 타임아웃 처리 패턴
class TimeoutRetryHandler:
    def __init__(self, max_retries=3):
        self.max_retries = max_retries
        self.retry_count = 0
    
    def on_timeout(self):
        self.retry_count += 1
        return self.retry_count < self.max_retries
    
    def reset(self):
        self.retry_count = 0
```

### 2. 무한 루프 방지 체크리스트

- [ ] 모든 `while True:` 루프에 종료 조건 확인
- [ ] 타임아웃 발생 시 재시도 횟수 제한
- [ ] 연결 상태 검증 로직 추가
- [ ] 예외 발생 시 적절한 대기 시간 설정
- [ ] 리소스 해제 보장 (finally 블록 활용)

### 3. 모니터링 강화

1. **타임아웃 메트릭 수집**
   - 타임아웃 발생 빈도
   - 재시도 횟수
   - 연결 종료 원인

2. **알림 설정**
   - 타임아웃이 임계값을 초과할 경우 알림
   - 특정 클라이언트의 반복적인 타임아웃 감지

### 4. 연결 관리 개선

```python
# 연결 상태 주기적 검증
async def validate_connection(reader, writer):
    if reader.at_eof():
        return False
    if writer.is_closing():
        return False
    try:
        # TCP keepalive 또는 애플리케이션 레벨 ping
        return True
    except:
        return False
```

## 향후 조치 사항

1. **즉시 조치**
   - [x] domaeka 서버 client_handler.py 수정
   - [x] kkobot 서버 client_handler.py 수정
   - [ ] 수정된 서버 재시작 및 모니터링

2. **단기 조치** (1주일 내)
   - [ ] kkobot scheduler.py 개선
   - [ ] 타임아웃 처리 표준 라이브러리 개발
   - [ ] 자동화된 무한 루프 탐지 도구 구축

3. **장기 조치** (1개월 내)
   - [ ] 전체 코드베이스 정적 분석
   - [ ] 스트레스 테스트 시나리오 구축
   - [ ] 시스템 안정성 모니터링 대시보드 구축

## 결론

타임아웃 무한 루프는 시스템 전체를 마비시킬 수 있는 치명적인 문제입니다. 이번 점검을 통해:

1. 두 개의 핵심 모듈에서 동일한 취약점 발견 및 수정
2. 추가적인 위험 요소 식별
3. 체계적인 개선 방안 수립

향후 이러한 문제가 재발하지 않도록 코드 리뷰 프로세스에 타임아웃 처리 검증을 필수 항목으로 추가하고, 자동화된 검증 도구를 도입할 예정입니다.

---
작성일: 2025-01-15
작성자: Claude (시스템 안정성 점검)