# Domaeka 프로젝트 개발 가이드라인

## 1. 프로젝트 개요

- **목표:** 기존 영카트5 기반의 단일 관리자 시스템을 **4계층(본사-총판-대리점-지점)** 관리자 구조로 확장합니다.
- **핵심 아키텍처:**
    - 기존 영카트5 시스템 위에 계층형 관리 기능을 추가합니다.
    - 모든 신규 기능은 `dmk/` 디렉토리 내에 구현하여 기존 시스템과의 분리를 유지합니다.
    - 데이터베이스는 `g5_member` 테이블을 확장하고, 각 계층을 위한 `dmk_distributor`, `dmk_agency`, `dmk_branch` 테이블을 사용합니다. 개인정보는 `g5_member`에 중앙화됩니다.
    - 모든 관리자 활동은 `dmk_action_logs` 테이블에 기록되어야 합니다.

## 2. 핵심 개발 규칙

### 규칙 1: 4단계 계층 구조 및 본사 권한

- 관리자 계층은 **본사 > 총판 > 대리점 > 지점** 순으로 구성됩니다.
- **본사 관리자**는 기존 영카트 최고관리자에 해당하며, 영카트의 모든 메뉴와 새로 생성된 모든 메뉴에 접근할 수 있는 **최고 권한**을 가집니다.

### 규칙 2: 계층별 메뉴 접근 제어

- **총판, 대리점, 지점** 관리자가 접근할 수 있는 메뉴는 `dmk/dmk_global_settings.php` 파일에 각 계층별로 명확하게 정의되어 있습니다.
- 각 계층의 관리자는 자신에게 허용된 메뉴 내에서 최고 관리자 역할을 수행합니다.

### 규칙 3: Main/Sub 관리자 권한 모델

- 각 계층(총판, 대리점, 지점)의 관리자는 **`main` 관리자**와 **`sub` 관리자**로 구분됩니다.
- **`main` 관리자:** 계층 당 1명만 존재하며, 해당 계층의 모든 기능에 접근할 수 있는 최고 관리자입니다.
- **`sub` 관리자:** 0명 이상 존재할 수 있으며, 기본적으로 아무 권한이 없습니다. `main` 관리자가 `g5_auth` 테이블을 통해 허용된 메뉴에 대한 접근 권한을 명시적으로 부여해야만 해당 기능을 사용할 수 있습니다.

### 규칙 4: 수정 가능한 메뉴 범위 식별

- 수정 및 개발이 허용된 메뉴는 아이콘으로 명확히 구분됩니다.
- <i class="fa fa-star" title="NEW"></i> (⭐): **신규 생성 메뉴**.
- <i class="fa fa-flag" title="개조"></i> (🚩): **기존 영카트 메뉴 개조**. 4단계 계층 구조가 반영되도록 수정된 메뉴입니다.
- **주의:** 위 두 아이콘이 표시되지 않은 메뉴는 **절대 수정해서는 안 됩니다.**

## 3. 표준 개발 패턴

### 파일 구조
- 대부분의 관리자 기능은 다음 3개의 파일 세트로 구성됩니다.
    - `_list.php`: 목록 조회 및 검색
    - `_form.php`: 데이터 등록 및 수정을 위한 폼
    - `_form_update.php`: 폼에서 제출된 데이터의 데이터베이스 처리 (등록/수정)

### 계층 선택 UI
- 목록 페이지에서의 검색 또는 등록/수정 폼에서의 소속 계층 지정을 위해 `dmk_render_chain_select` 함수가 사용됩니다.
- 이 함수는 동적인 AJAX 기반의 계층 선택박스(총판-대리점-지점)를 렌더링하는 핵심적인 역할을 합니다.
- **참고:** 일부 레거시 코드에는 이 함수가 적용되지 않았을 수 있으므로, 개발 시 해당 함수의 유무를 확인하여 신규 코드와 레거시 코드를 구분해야 합니다.

## 4. 권한 검토 및 개선 사항

### 4.1. 총판 관리 (`dmk/adm/distributor_admin/`)

- **`distributor_list.php` (목록):**
    - `dmk_can_access_menu()`를 통한 메뉴 접근 권한 확인이 올바르게 구현되어 있습니다.
    - 로그인한 관리자 계층(본사, 총판, 대리점/지점)에 따라 데이터 조회 권한이 정확하게 필터링됩니다.
    - 총판 등록 버튼은 본사 관리자에게만 노출됩니다.
    - **결론:** 권한 로직에 문제 없음.

- **`distributor_form.php` (등록/수정 폼):**
    - `dmk_authenticate_form_access()`를 통한 통합 권한 관리가 올바르게 구현되어 있습니다.
    - 총판 관리자가 자신의 정보를 수정할 때 '총판 상태' 필드를 변경할 수 없도록 제어하는 로직이 올바르게 작동합니다.
    - **결론:** 권한 로직에 문제 없음.

- **`distributor_form_update.php` (등록/수정 DB 처리):**
    - `dmk_authenticate_form_access()`를 통한 통합 권한 관리가 올바르게 구현되어 있습니다.
    - `check_token()`을 통한 CSRF 방어가 적용되어 있습니다.
    - `dmk_log_admin_action()`을 통한 관리자 액션 로깅이 올바르게 구현되어 있습니다.
    - **결론:** 권한 로직에 문제 없음.

### 4.2. 대리점 관리 (`dmk/adm/agency_admin/`)

- **`agency_list.php` (목록):**
    - `dmk_can_access_menu()`를 통한 메뉴 접근 권한 확인이 올바르게 구현되어 있습니다.
    - 로그인한 관리자 계층(본사, 총판, 대리점, 지점)에 따라 데이터 조회 권한이 정확하게 필터링됩니다.
    - 대리점 등록 버튼은 `dmk_can_create_admin('agency')` 함수를 통해 권한이 확인됩니다.
    - **결론:** 권한 로직에 문제 없음.

- **`agency_form.php` (등록/수정 폼):**
    - `dmk_authenticate_form_access()`를 통한 통합 권한 관리가 올바르게 구현되어 있습니다.
    - '소속 총판' 필드가 로그인한 관리자 계층에 따라 올바르게 제어됩니다 (본사: 선택 가능, 총판: 자신의 총판으로 고정, 대리점: 자신의 총판으로 고정).
    - '대리점 상태' 필드도 역할에 따라 접근이 제어됩니다 (대리점 관리자는 자신의 상태 변경 불가).
    - **결론:** 권한 로직에 문제 없음.

- **`agency_form_update.php` (등록/수정 DB 처리):**
    - `dmk_authenticate_form_access()`를 통한 통합 권한 관리가 올바르게 구현되어 있습니다.
    - `check_admin_token()`을 통한 CSRF 방어가 적용되어 있습니다.
    - 총판 관리자가 자신의 총판에만 대리점을 등록할 수 있도록 `dt_id` 유효성 검사가 명시적으로 구현되어 있습니다.
    - `dmk_log_admin_action()`을 통한 관리자 액션 로깅이 올바르게 구현되어 있습니다.
    - **결론:** 권한 로직에 문제 없음.

### 4.3. 지점 관리 (`dmk/adm/branch_admin/`)

- **`branch_list.php` (목록):**
    - `dmk_can_access_menu()`를 통한 메뉴 접근 권한 확인이 올바르게 구현되어 있습니다.
    - 로그인한 관리자 계층(본사, 총판, 대리점, 지점)에 따라 데이터 조회 권한이 정확하게 필터링됩니다.
    - 지점 등록 버튼은 `dmk_can_create_admin('branch')` 함수를 통해 권한이 확인됩니다.
    - **결론:** 권한 로직에 문제 없음.

- **`branch_form.php` (등록/수정 폼):**
    - `dmk_authenticate_form_access()`를 통한 통합 권한 관리가 올바르게 구현되어 있습니다.
    - '소속 총판' 및 '소속 대리점' 필드가 로그인한 관리자 계층에 따라 올바르게 제어됩니다.
    - '지점명', '단축 URL 코드', '지점 상태' 필드 등 민감한 필드에 대한 지점 관리자의 수정 권한이 올바르게 제한됩니다.
    - **결론:** 권한 로직에 문제 없음.

- **`branch_form_update.php` (등록/수정 DB 처리):**
    - **개선 전 문제점:** `dmk_authenticate_form_access()` 함수 호출이 누락되어 있었습니다.
    - **개선 후:** `dmk_authenticate_form_access()` 함수 호출을 추가하여 폼 제출 시점에도 통합 권한 검증이 이루어지도록 수정했습니다.
    - `check_admin_token()`을 통한 CSRF 방어가 적용되어 있습니다.
    - 각 계층별 지점 등록/수정 권한 검증 로직이 명시적으로 구현되어 있습니다.
    - `dmk_log_admin_action()`을 통한 관리자 액션 로깅이 올바르게 구현되어 있습니다.
    - **결론:** 권한 로직 개선 완료.

### 4.4. 통계 분석 (`dmk/adm/statistics/statistics_dashboard.php`)

- **`statistics_dashboard.php` (대시보드):**
    - **개선 전 문제점:**
        - `dmk_can_access_menu()` 대신 `mb_type`을 직접 비교하여 메뉴 접근 권한을 제어하고 있었습니다. 이는 `dmk_global_settings.php`의 설정을 무시하는 문제였습니다.
        - `DMK_BRANCH_MB_TYPE` 상수가 중복 정의되어 있었고, 값이 `dmk_global_settings.php`와 달랐습니다.
        - 지점 관리자의 데이터 필터링 시 `dmk_auth['br_id']`를 사용하고 있었으나, `dmk_auth` 배열에는 `br_id`가 없었습니다.
    - **개선 후:**
        - 메뉴 접근 권한 확인을 `dmk_can_access_menu($sub_menu, dmk_get_current_user_type())`로 변경하여 중앙 집중식 권한 관리를 따르도록 수정했습니다.
        - 중복 정의된 `DMK_BRANCH_MB_TYPE` 상수를 제거했습니다.
        - 지점 관리자의 데이터 필터링 변수를 `dmk_auth['mb_id']`로 수정했습니다.
    - **결론:** 권한 로직 개선 완료.
