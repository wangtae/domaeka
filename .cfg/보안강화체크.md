# ë„ë§¤ê¹Œ ì¹´ì¹´ì˜¤ë´‡ ì„œë²„ ë³´ì•ˆ ê°•í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

## âœ… í˜„ì¬ ë³´ì•ˆ ìˆ˜ì¤€ í‰ê°€

### ì´ë¯¸ êµ¬í˜„ëœ ë³´ì•ˆ ê¸°ëŠ¥
1. **HMAC ì¸ì¦** - ìš”ì²­ ìœ„ë³€ì¡° ë°©ì§€ âœ…
2. **ë´‡ ìŠ¹ì¸ ì‹œìŠ¤í…œ** - í—ˆê°€ëœ ë””ë°”ì´ìŠ¤ë§Œ ì‚¬ìš© âœ…
3. **ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”** - ìë™ ê°€ì… ë¶ˆê°€ âœ…

**í˜„ì¬ ìœ„í—˜ë„**: â˜…â˜…â˜†â˜†â˜† (ë‚®ìŒ)

## ğŸ”’ ì¶”ê°€ ë³´ì•ˆ ê°•í™” ë°©ì•ˆ

### 1. Rate Limiting êµ¬í˜„

```python
# Redisë¥¼ í™œìš©í•œ ë´‡ë³„ ìš”ì²­ ì œí•œ
import aioredis
from datetime import datetime

class RateLimiter:
    def __init__(self):
        self.redis = None
        self.limits = {
            'per_minute': 300,      # ë¶„ë‹¹ 300íšŒ
            'per_hour': 10000,      # ì‹œê°„ë‹¹ 10,000íšŒ
            'per_day': 100000       # ì¼ë‹¹ 100,000íšŒ
        }
    
    async def connect(self):
        self.redis = await aioredis.create_redis_pool('redis://localhost')
    
    async def check_rate_limit(self, device_id):
        """ë´‡ë³„ ìš”ì²­ ì œí•œ í™•ì¸"""
        now = datetime.now()
        keys = {
            'minute': f"rate:{device_id}:{now.strftime('%Y%m%d%H%M')}",
            'hour': f"rate:{device_id}:{now.strftime('%Y%m%d%H')}",
            'day': f"rate:{device_id}:{now.strftime('%Y%m%d')}"
        }
        
        for period, key in keys.items():
            current = await self.redis.incr(key)
            if current == 1:
                expire_seconds = {'minute': 60, 'hour': 3600, 'day': 86400}
                await self.redis.expire(key, expire_seconds[period])
            
            if current > self.limits[f'per_{period}']:
                logging.warning(f"Rate limit exceeded for {device_id}: {period}")
                return False, f"Rate limit exceeded: {period}"
        
        return True, None
```

### 2. ë¹„ì •ìƒ íŒ¨í„´ ê°ì§€ ì‹œìŠ¤í…œ

```python
class AnomalyDetector:
    def __init__(self):
        self.suspicious_patterns = {
            "rapid_reconnect": {"threshold": 10, "window": 60},        # 60ì´ˆ ë‚´ 10íšŒ ì¬ì—°ê²°
            "unusual_hour": {"hours": [2, 3, 4, 5]},                  # ìƒˆë²½ 2-5ì‹œ í™œë™
            "bulk_messages": {"threshold": 100, "window": 60},        # ë¶„ë‹¹ 100ê°œ ì´ìƒ
            "failed_auth": {"threshold": 5, "window": 300},           # 5ë¶„ ë‚´ 5íšŒ ì¸ì¦ ì‹¤íŒ¨
            "room_hopping": {"threshold": 20, "window": 60}           # ë¶„ë‹¹ 20ê°œ ì´ìƒ ë°© ì „í™˜
        }
    
    async def check_patterns(self, device_id, event_type, metadata):
        """ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒ¨í„´ í™•ì¸"""
        # ìƒˆë²½ ì‹œê°„ëŒ€ í™œë™ ì²´í¬
        current_hour = datetime.now().hour
        if current_hour in self.suspicious_patterns["unusual_hour"]["hours"]:
            await self.log_suspicious_activity(device_id, "unusual_hour", metadata)
        
        # ë¹ ë¥¸ ì¬ì—°ê²° ì²´í¬
        if event_type == "connect":
            reconnect_count = await self.get_event_count(device_id, "connect", 60)
            if reconnect_count > self.suspicious_patterns["rapid_reconnect"]["threshold"]:
                await self.log_suspicious_activity(device_id, "rapid_reconnect", metadata)
                return False
        
        return True
    
    async def log_suspicious_activity(self, device_id, pattern_type, metadata):
        """ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ ë¡œê¹…"""
        await db.execute("""
            INSERT INTO kb_suspicious_activities 
            (device_id, pattern_type, metadata, created_at)
            VALUES (?, ?, ?, NOW())
        """, (device_id, pattern_type, json.dumps(metadata)))
```

### 3. ìë™í™”ëœ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§

#### 3.1 ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë‹ˆí„°ë§ ì¿¼ë¦¬

```sql
-- ì¼ì¼ ë³´ì•ˆ ë¦¬í¬íŠ¸
CREATE VIEW v_daily_security_report AS
SELECT 
    d.device_id,
    d.device_name,
    COUNT(l.id) as total_requests,
    COUNT(DISTINCT l.room) as unique_rooms,
    SUM(CASE WHEN l.status = 'failed' THEN 1 ELSE 0 END) as failed_requests,
    SUM(CASE WHEN l.event = 'hmac_failed' THEN 1 ELSE 0 END) as hmac_failures,
    MAX(l.created_at) as last_activity
FROM kb_bot_devices d
LEFT JOIN kb_chat_logs l ON d.device_id = l.device_id
WHERE l.created_at >= NOW() - INTERVAL 1 DAY
GROUP BY d.device_id, d.device_name
HAVING failed_requests > 10 OR hmac_failures > 0
ORDER BY failed_requests DESC, total_requests DESC;

-- ì‹œê°„ëŒ€ë³„ í™œë™ íŒ¨í„´
CREATE VIEW v_hourly_activity_pattern AS
SELECT 
    HOUR(created_at) as hour,
    COUNT(*) as request_count,
    COUNT(DISTINCT device_id) as active_devices
FROM kb_chat_logs
WHERE created_at >= NOW() - INTERVAL 7 DAY
GROUP BY HOUR(created_at)
ORDER BY hour;

-- IPë³„ ì ‘ì† ì‹œë„
CREATE VIEW v_ip_connection_attempts AS
SELECT 
    ip_address,
    COUNT(*) as attempt_count,
    SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as success_count,
    SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_count,
    MIN(created_at) as first_seen,
    MAX(created_at) as last_seen
FROM kb_connection_logs
WHERE created_at >= NOW() - INTERVAL 1 DAY
GROUP BY ip_address
HAVING failed_count > 5
ORDER BY failed_count DESC;
```

#### 3.2 ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ (PHP)

```php
// dmk/admin/security_dashboard.php
<?php
include_once('./_common.php');

// ì‹¤ì‹œê°„ ë³´ì•ˆ ë©”íŠ¸ë¦­
$security_metrics = [
    'active_bots' => sql_fetch("SELECT COUNT(*) as cnt FROM kb_bot_devices WHERE status = 'approved' AND last_ping > NOW() - INTERVAL 5 MINUTE")['cnt'],
    'today_requests' => sql_fetch("SELECT COUNT(*) as cnt FROM kb_chat_logs WHERE created_at >= CURDATE()")['cnt'],
    'failed_auths' => sql_fetch("SELECT COUNT(*) as cnt FROM kb_chat_logs WHERE event = 'hmac_failed' AND created_at >= NOW() - INTERVAL 1 HOUR")['cnt'],
    'suspicious_activities' => sql_fetch("SELECT COUNT(*) as cnt FROM kb_suspicious_activities WHERE created_at >= CURDATE()")['cnt']
];

// ìë™ ì•Œë¦¼ ì²´í¬
if ($security_metrics['failed_auths'] > 50) {
    send_admin_alert("ë¹„ì •ìƒì ì¸ ì¸ì¦ ì‹¤íŒ¨ ê°ì§€: {$security_metrics['failed_auths']}íšŒ/ì‹œê°„");
}

if ($security_metrics['suspicious_activities'] > 20) {
    send_admin_alert("ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ ì¦ê°€: {$security_metrics['suspicious_activities']}ê±´/ì¼");
}
?>

<div class="security-dashboard">
    <h2>ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h2>
    
    <div class="metric-cards">
        <div class="card <?php echo $security_metrics['failed_auths'] > 10 ? 'alert' : ''; ?>">
            <h3>ì¸ì¦ ì‹¤íŒ¨</h3>
            <span class="value"><?php echo $security_metrics['failed_auths']; ?></span>
            <span class="label">ìµœê·¼ 1ì‹œê°„</span>
        </div>
        
        <div class="card">
            <h3>í™œì„± ë´‡</h3>
            <span class="value"><?php echo $security_metrics['active_bots']; ?></span>
            <span class="label">í˜„ì¬</span>
        </div>
    </div>
    
    <!-- ì‹¤ì‹œê°„ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ -->
    <div id="realtime-logs"></div>
</div>

<script>
// WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
const ws = new WebSocket('ws://localhost:9999/security-logs');
ws.onmessage = function(event) {
    const log = JSON.parse(event.data);
    if (log.severity === 'critical') {
        showAlert(log.message);
    }
    appendLog(log);
};
</script>
```

### 4. í¬íŠ¸ ì˜¤í”ˆ ê¶Œì¥ ì„¤ì •

```yaml
# AWS/í´ë¼ìš°ë“œ ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •
ì¸ë°”ìš´ë“œ ê·œì¹™:
  # ì›¹ ì„œë¹„ìŠ¤
  - Type: HTTP
    Port: 80
    Source: 0.0.0.0/0
    Description: Public Web Service
  
  - Type: HTTPS
    Port: 443
    Source: 0.0.0.0/0
    Description: Public Web Service (SSL)
  
  # ì¹´ì¹´ì˜¤ë´‡ ì„œë²„ (HMAC ë³´í˜¸)
  - Type: Custom TCP
    Port Range: 1481-1483
    Source: 0.0.0.0/0
    Description: KakaoBot Test Servers (HMAC Protected) âœ…
  
  - Type: Custom TCP
    Port Range: 1491-1493
    Source: 0.0.0.0/0
    Description: KakaoBot Live Servers (HMAC Protected) âœ…
  
  # ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ (ë°˜ë“œì‹œ IP ì œí•œ)
  - Type: Custom TCP
    Port Range: 9101-9113
    Source: ê´€ë¦¬ìIP/32
    Description: Supervisor Web UI (Admin Only) âš ï¸
  
  - Type: MySQL/Aurora
    Port: 3307
    Source: VPC ë‚´ë¶€ë§Œ
    Description: Database (Internal Only) âŒ
```

## ğŸ›¡ï¸ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ë„êµ¬ ì¶”ì²œ

### 1. ì˜¤í”ˆì†ŒìŠ¤ ë„êµ¬

#### Fail2ban
```bash
# /etc/fail2ban/jail.local
[kakaobot-hmac]
enabled = true
port = 1481-1493
filter = kakaobot-hmac
logpath = /var/log/kakaobot/security.log
maxretry = 10
findtime = 600
bantime = 3600
action = iptables-multiport[name=kakaobot, port="1481:1493"]

# /etc/fail2ban/filter.d/kakaobot-hmac.conf
[Definition]
failregex = ^<HOST> .* HMAC verification failed.*$
            ^<HOST> .* Unauthorized bot attempt.*$
            ^<HOST> .* Rate limit exceeded.*$
```

#### Grafana + Prometheus
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'kakaobot'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: '/metrics'
    
# ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­ ì˜ˆì‹œ
kakaobot_auth_failures_total
kakaobot_rate_limit_hits_total
kakaobot_active_connections
kakaobot_message_processing_duration_seconds
```

#### ELK Stack (Elasticsearch + Logstash + Kibana)
```json
// Logstash ì„¤ì •
input {
  file {
    path => "/var/log/kakaobot/*.log"
    start_position => "beginning"
    codec => "json"
  }
}

filter {
  if [event] == "security" {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "kakaobot-security-%{+YYYY.MM.dd}"
  }
}
```

### 2. ìƒìš© ë„êµ¬

#### Cloudflare (DDoS ë°©ì–´)
- Rate Limiting Rules
- Bot Fight Mode
- WAF (Web Application Firewall)

#### Datadog
- ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§
- ì´ìƒ ì§•í›„ ìë™ ê°ì§€
- ì•Œë¦¼ í†µí•© (Slack, Email, SMS)

#### New Relic
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
- ë³´ì•ˆ ì´ë²¤íŠ¸ ì¶”ì 
- ì»¤ìŠ¤í…€ ëŒ€ì‹œë³´ë“œ

### 3. ìì²´ êµ¬ì¶• ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# security_monitor.sh - í¬ë¡ íƒ­ì— ë“±ë¡í•˜ì—¬ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰

LOG_DIR="/var/log/kakaobot"
ALERT_EMAIL="admin@domaeka.com"

# HMAC ì‹¤íŒ¨ ì²´í¬
HMAC_FAILS=$(grep -c "HMAC failed" $LOG_DIR/security.log | tail -300)
if [ $HMAC_FAILS -gt 50 ]; then
    echo "Alert: $HMAC_FAILS HMAC failures in last 5 minutes" | mail -s "Security Alert" $ALERT_EMAIL
fi

# ë¹„ì •ìƒ IP ì²´í¬
SUSPICIOUS_IPS=$(awk '/failed/ {print $1}' $LOG_DIR/access.log | sort | uniq -c | sort -nr | head -10)
echo "$SUSPICIOUS_IPS" > /tmp/suspicious_ips.txt

# ìë™ ì°¨ë‹¨
while read count ip; do
    if [ $count -gt 100 ]; then
        iptables -A INPUT -s $ip -j DROP
        echo "Blocked IP: $ip (failures: $count)" | mail -s "IP Blocked" $ALERT_EMAIL
    fi
done < /tmp/suspicious_ips.txt
```

## ğŸ“‹ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¼ì¼ ì ê²€ ì‚¬í•­
- [ ] ì‹ ê·œ ë´‡ ìŠ¹ì¸ ìš”ì²­ í™•ì¸
- [ ] HMAC ì¸ì¦ ì‹¤íŒ¨ ë¡œê·¸ ê²€í† 
- [ ] ë¹„ì •ìƒ ì‹œê°„ëŒ€ í™œë™ í™•ì¸
- [ ] Rate limit ì´ˆê³¼ ë´‡ í™•ì¸

### ì£¼ê°„ ì ê²€ ì‚¬í•­
- [ ] ë³´ì•ˆ íŒ¨ì¹˜ ì—…ë°ì´íŠ¸
- [ ] ë¡œê·¸ íŒŒì¼ ë¡œí…Œì´ì…˜ í™•ì¸
- [ ] ë°±ì—… ìƒíƒœ ì ê²€
- [ ] ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¶„ì„

### ì›”ê°„ ì ê²€ ì‚¬í•­
- [ ] ë¯¸ì‚¬ìš© ë´‡ ì •ë¦¬
- [ ] ë³´ì•ˆ ì •ì±… ê²€í† 
- [ ] ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸ ì‹¤ì‹œ
- [ ] ë³´ì•ˆ êµìœ¡ ì‹¤ì‹œ

## ğŸš¨ ê¸´ê¸‰ ëŒ€ì‘ ê°€ì´ë“œ

### 1. DDoS ê³µê²© ì‹œ
```bash
# ì„ì‹œ ì°¨ë‹¨
iptables -A INPUT -p tcp --dport 1481:1493 -j DROP

# Cloudflare í™œì„±í™”
# DNSë¥¼ Cloudflareë¡œ ë³€ê²½

# ë¡œê·¸ ë¶„ì„
tcpdump -i eth0 -w ddos_attack.pcap port 1481
```

### 2. ëŒ€ëŸ‰ ì¸ì¦ ì‹¤íŒ¨ ì‹œ
```bash
# ì˜ì‹¬ IP ì¶”ì¶œ
grep "HMAC failed" /var/log/kakaobot/*.log | awk '{print $1}' | sort | uniq -c | sort -nr

# fail2ban ì„ì‹œ ê·œì¹™ ê°•í™”
fail2ban-client set kakaobot-hmac bantime 86400
fail2ban-client set kakaobot-hmac maxretry 3
```

### 3. ë°ì´í„° ìœ ì¶œ ì˜ì‹¬ ì‹œ
```sql
-- ë¹„ì •ìƒ ëŒ€ëŸ‰ ì¡°íšŒ í™•ì¸
SELECT device_id, COUNT(*) as query_count
FROM kb_query_logs
WHERE created_at >= NOW() - INTERVAL 1 HOUR
GROUP BY device_id
HAVING query_count > 1000;

-- ì¦‰ì‹œ ì°¨ë‹¨
UPDATE kb_bot_devices 
SET status = 'blocked', 
    blocked_reason = 'Suspicious activity',
    blocked_at = NOW()
WHERE device_id IN (/* ì˜ì‹¬ device_id ëª©ë¡ */);
```

## ğŸ“š ì°¸ê³  ìë£Œ

- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
- [CIS Controls](https://www.cisecurity.org/controls)
- [Docker Security Best Practices](https://docs.docker.com/engine/security/)

---
*ìµœì¢… ì—…ë°ì´íŠ¸: 2025-01-22*